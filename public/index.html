<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Warehouse Tracker" />
    <meta name="theme-color" content="#2C3E50" />
    <title>Warehouse Tracker</title>

    <link rel="manifest" href="/manifest.json" />
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <body class="bg-slate-50">
    <div id="app">
      <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;color:#334155;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;">
        Loading Warehouse Tracker...
      </div>
    </div>

    <div id="toast-container"></div>
    <div id="modal-container"></div>

    <script>
      (function () {
        function showBootError(message) {
          var app = document.getElementById("app");
          if (!app) return;
          app.innerHTML = '' +
            '<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">' +
              '<div style="max-width:560px;width:100%;border:1px solid #fecaca;background:#fff1f2;color:#881337;border-radius:14px;padding:16px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;">' +
                '<div style="font-weight:700;margin-bottom:8px;">App failed to load</div>' +
                '<div style="font-size:14px;line-height:1.45;">' + message + '</div>' +
              '</div>' +
            '</div>';
        }

        function browserSupportsAppSyntax() {
          try {
            // eslint-disable-next-line no-new-func
            new Function('var x={a:1}; return (x?.a ?? 0) === 1;')();
            return true;
          } catch (_) {
            return false;
          }
        }

        function loadScript(src, opts) {
          opts = opts || {};
          return new Promise(function (resolve, reject) {
            var s = document.createElement('script');
            s.src = src;
            if (opts.defer) s.defer = true;
            if (opts.async) s.async = true;
            s.onload = function () { resolve(true); };
            s.onerror = function () { reject(new Error('Failed to load ' + src)); };
            document.body.appendChild(s);
          });
        }

        function onAppScriptError(evt) {
          if (window.__WT_APP_BOOT_OK__) return;
          if (evt && evt.filename && String(evt.filename).includes('/app.js')) {
            showBootError('JavaScript error while loading app.js.');
          }
        }

        window.addEventListener('error', onAppScriptError);

        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function () {
            navigator.serviceWorker.register('/sw.js').catch(function () {});
          });
        }

        if (!browserSupportsAppSyntax()) {
          showBootError('This iPhone/Safari version is too old for this app build. Update iOS/Safari.');
          return;
        }

        // Load app first so page can render even if third-party CDNs are slow.
        loadScript('/app.js', { defer: true })
          .then(function () {
            window.__WT_APP_BOOT_OK__ = true;
            window.removeEventListener('error', onAppScriptError);
          })
          .catch(function () {
            showBootError('Could not load app.js. Check connection and try again.');
          });

        // Load optional libraries without blocking first paint.
        loadScript('/socket.io/socket.io.js', { async: true }).catch(function () {});
        loadScript('https://cdn.tailwindcss.com', { async: true }).catch(function () {});
        loadScript('https://unpkg.com/html5-qrcode', { async: true }).catch(function () {});
        loadScript('https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js', { async: true }).catch(function () {});
        loadScript('https://cdn.jsdelivr.net/npm/chart.js', { async: true }).catch(function () {});

        setTimeout(function () {
          if (!window.__WT_APP_LOADED__) {
            showBootError('Startup timed out. Disable content blockers/VPN on iPhone and reload.');
          }
        }, 12000);
      })();
    </script>
  </body>
</html>
